{% extends 'techstore/storeuser-page.html' %}
{% block usercontent %}
<div class="container mt-4">
  <ul class="nav nav-tabs" id="ordersTab" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="stock-tab" data-bs-toggle="tab" href="#stock" role="tab">Supplied items</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="create-tab" data-bs-toggle="tab" href="#create" role="tab">Create Supply Order</a>
    </li>
  </ul>
  
  <div class="tab-content mt-3">
    <div class="tab-pane fade show active" id="stock">
      <h3>Products Supplied</h3>
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
      <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
        {% if user_orders %}
      
        <table class="table table-bordered mt-3 w-100 table-hover">
          <thead class="table-info sticky-top">
            <tr>
              <th>#</th>
              <th>Category</th>
              <th>Model</th>
              <th>Quantity</th>
              <th>Supplied Date</th>
              <th>Description</th>
              <th>Received Person</th>
              <th>Action</th> <!-- ðŸ‘ˆ New column -->
            </tr>
          </thead>
          <tbody>
            {% for order in user_orders %}
              <tr data-id="{{ order.id }}">
                <td>{{ forloop.counter }}</td>
                <td>{{ order.category.name }}</td>
                <td>{{ order.model.model }}</td>
                <td>{{ order.quantity_supplied }}</td>
                <td>{{ order.supplied_date }}</td>
                <td>{{ order.description }}</td>
                <td>{{ order.received_person_name }}</td>
                <td>
                  {% if not order.item_returned_date %}
                    <button class="btn btn-sm btn-info edit-user-order"
                      data-id="{{ order.id }}"
                      data-category="{{ order.category.id }}"
                      data-model="{{ order.model.id }}"
                      data-quantity="{{ order.quantity_supplied }}"
                      data-supplied_date="{{ order.supplied_date|date:'Y-m-d' }}"
                      data-description="{{ order.description }}"
                      data-received="{{ order.received_person_name }}">
                      Edit
                    </button>
              
                    <button class="btn btn-sm btn-danger delete-btn" data-id="{{ order.id }}">Delete</button>
                    <button class="btn btn-sm btn-warning return-btn" data-id="{{ order.id }}">Item Returned</button>
                    {% else %}
                    <span class="text-muted">Item Returned</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      
        {% else %}
          <p>No supply orders submitted yet.</p>
        {% endif %}
      </div>

      <hr>
      <h4 class="mt-5">Returned Supply Orders</h4>
      <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
        <table class="table table-bordered mt-3 w-100 table-hover">
            <thead class="table-info sticky-top">
                <tr>
                    <th>#</th>
                    <th>Category</th>
                    <th>Model</th>
                    <th>Quantity Supplied</th>
                    <th>Supplied Date</th>
                    <th>Description</th>
                    <th>Received Person</th>
                    <th>Returned Date</th>
                </tr>
            </thead>
            <tbody id="active-orders-body">
              
                {% if returned_orders %}
                    {% for order in returned_orders %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ order.category.name }}</td>
                            <td>{{ order.model.model }}</td>
                            <td>{{ order.quantity_supplied }}</td>
                            <td>{{ order.supplied_date }}</td>
                            <td>{{ order.description|default:"â€”" }}</td>
                            <td>{{ order.received_person_name }}</td>
                            <td>{{ order.item_returned_date }}</td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="8" class="text-center">No returned supply orders found.</td>
                    </tr>
                {% endif %}
              
            </tbody>
        </table>
      </div>
    </div>
    <div class="tab-pane fade" id="create" role="tabpanel">
      <h3>Create Supply Order</h3>
      <form method="post" action="{% url 'create_user_supply_order' %}">
        {% csrf_token %}
        <input type="hidden" name="edit_order_id" id="edit_order_id">
        
        <div class="mb-3">
          <label for="category">Category</label>
          <select name="category" id="userCategorySelect" class="form-control" required>
            <option value="">Select Category</option>
            {% for category in categories %}
              <option value="{{ category.id }}">{{ category.name }}</option>
            {% endfor %}
          </select>
        </div>
    
        <div class="mb-3">
          <label for="model">Model</label>
          <select name="model" id="userModelSelect" class="form-control" required>
            <option value="">Select Model</option>
          </select>
        </div>
      
        <div class="mb-3">
          <label for="quantity_supplied">Quantity Supplied</label>
          <select name="quantity_supplied" id="userQuantitySelect" class="form-control" required>
            <option value="">Select Quantity</option>
          </select>
        </div>
      
        <div class="mb-3">
          <label for="supplied_date">Supplied Date</label>
          <input type="date" name="supplied_date" class="form-control" required>
        </div>
      
        <div class="mb-3">
          <label for="description">Description</label>
          <textarea name="description" class="form-control" rows="2" required></textarea>
        </div>
      
        <div class="mb-3">
          <label for="received_person_name">Received Person Name</label>
          <input type="text" name="received_person_name" class="form-control" required>
        </div>
      
        <button type="submit" class="btn btn-primary">Submit</button>
      </form>
    </div>
  </div>

  {% comment %} script for edit button  {% endcomment %}
  <script>
    document.querySelectorAll('.edit-user-order').forEach(button => {
      button.addEventListener('click', function () {
        // Fill static fields
        document.getElementById('edit_order_id').value = this.dataset.id;
        document.querySelector('[name="description"]').value = this.dataset.description;
        document.querySelector('[name="received_person_name"]').value = this.dataset.received;
        document.querySelector('[name="supplied_date"]').value = this.dataset.supplied_date;
  
        // Set category
        const categorySelect = document.getElementById('userCategorySelect');
        categorySelect.value = this.dataset.category;
  
        // Trigger change to populate model dropdown
        const event = new Event('change');
        categorySelect.dispatchEvent(event);
  
        // Wait for models to be populated via AJAX before setting selected model and quantity
        setTimeout(() => {
          const modelSelect = document.getElementById('userModelSelect');
          modelSelect.value = this.dataset.model;
        
          // Trigger model change to reload quantity (this can be skipped in edit mode)
          // modelSelect.dispatchEvent(new Event('change'));
        
          setTimeout(() => {
            const quantitySelect = document.getElementById('userQuantitySelect');
            const originalQuantity = parseInt(this.dataset.quantity);
        
            // Clear existing options
            quantitySelect.innerHTML = '<option value="">Select Quantity</option>';
        
            // Populate quantity options from 1 to original quantity
            for (let i = 1; i <= originalQuantity; i++) {
              const option = document.createElement('option');
              option.value = i;
              option.textContent = i;
              quantitySelect.appendChild(option);
            }
        
            // Select original quantity
            quantitySelect.value = originalQuantity;
        
          }, 300);
        }, 300);
        
  
        // ðŸ”„ Switch to "Create Supply Order" tab
        const createTabTrigger = new bootstrap.Tab(document.querySelector('#create-tab'));
        createTabTrigger.show();
  
        // Scroll to form
        document.querySelector('form').scrollIntoView({ behavior: 'smooth' });
      });
    });
  </script>
  
    
  {% comment %} script to update models based on category selection {% endcomment %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
        const categorySelect = document.getElementById('userCategorySelect');
        const modelSelect = document.getElementById('userModelSelect');
    
        categorySelect.addEventListener('change', function () {
            const categoryId = this.value;
            modelSelect.innerHTML = '<option value="">Loading...</option>';
    
            fetch(`/store-user/get-models/?category_id=${categoryId}`)
                .then(response => response.json())
                .then(data => {
                    modelSelect.innerHTML = '<option value="">Select Model</option>';
                    data.models.forEach(model => {
                        modelSelect.innerHTML += `<option value="${model.id}">${model.model}</option>`;
                    });
                })
                .catch(error => {
                    modelSelect.innerHTML = '<option value="">Error loading models</option>';
                    console.error('Error:', error);
                });
        });
    });
  </script>

  {% comment %} script to update quantity based on model selection  {% endcomment %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
        const categorySelect = document.getElementById('userCategorySelect');
        const modelSelect = document.getElementById('userModelSelect');
        const quantitySelect = document.getElementById('userQuantitySelect');
    
        categorySelect.addEventListener('change', function () {
            const categoryId = this.value;
            modelSelect.innerHTML = '<option value="">Loading...</option>';
            quantitySelect.innerHTML = '<option value="">Select Quantity</option>';
    
            fetch(`/store-user/get-models/?category_id=${categoryId}`)
                .then(response => response.json())
                .then(data => {
                    modelSelect.innerHTML = '<option value="">Select Model</option>';
                    data.models.forEach(model => {
                        modelSelect.innerHTML += `<option value="${model.id}">${model.model}</option>`;
                    });
                });
        });
    
        modelSelect.addEventListener('change', function () {
            const modelId = this.value;
            quantitySelect.innerHTML = '<option value="">Loading...</option>';
    
            fetch(`/store-user/get-available-quantity/?model_id=${modelId}`)
                .then(response => response.json())
                .then(data => {
                    quantitySelect.innerHTML = '<option value="">Select Quantity</option>';
                    for (let i = 1; i <= data.available_quantity; i++) {
                        quantitySelect.innerHTML += `<option value="${i}">${i}</option>`;
                    }
                    if (data.available_quantity === 0) {
                        quantitySelect.innerHTML = '<option value="">No quantity available</option>';
                    }
                });
        });
    });
  </script>
  
    
  {% comment %} script to handle delete, return and edit actions {% endcomment %}
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // DELETE
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          if (!confirm("Are you sure you want to delete this order?")) return;
          fetch("{% url 'delete_user_supply_order' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: new URLSearchParams({ 'id': btn.dataset.id })
          }).then(res => res.json()).then(data => {
            if (data.success) {
              btn.closest('tr').remove();
            } else {
              alert("Error: " + data.error);
            }
          });
        });
      });
    
      // RETURN
      document.querySelectorAll('.return-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          fetch("{% url 'mark_item_returned' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: new URLSearchParams({ 'id': btn.dataset.id })
          }).then(res => res.json()).then(data => {
            if (data.success) {
              const row = btn.closest('tr');
              row.querySelector('.return-btn').remove();
              row.querySelector('.delete-btn').remove();
              row.querySelector('.edit-btn').remove();
              row.querySelector('td:last-child').innerHTML = '<span class="text-success">Item Returned</span>';
            } else {
              alert("Error: " + data.error);
            }
          });
        });
      });
    
      // EDIT
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const row = btn.closest('tr');
          const id = btn.dataset.id;
          const category = row.children[1].innerText.trim();
          const model = row.children[2].innerText.trim();
          const quantity = row.children[3].innerText.trim();
          const date = row.children[4].innerText.trim();
          const desc = row.children[5].innerText.trim();
          const person = row.children[6].innerText.trim();
    
          document.querySelector('input[name="edit_order_id"]').value = id;
          document.querySelector('select[name="category"]').value = [...document.querySelector('select[name="category"]').options].find(o => o.text === category)?.value;
          setTimeout(() => {
            document.querySelector('select[name="model"]').value = [...document.querySelector('select[name="model"]').options].find(o => o.text === model)?.value;
          }, 300);
          document.querySelector('select[name="quantity_supplied"]').value = quantity;
          document.querySelector('input[name="supplied_date"]').value = date;
          document.querySelector('textarea[name="description"]').value = desc;
          document.querySelector('input[name="received_person_name"]').value = person;
    
          window.scrollTo({ top: document.querySelector('#supply-form').offsetTop, behavior: 'smooth' });
        });
      });
    });
  </script>
    


  </div>


{% endblock %}