{% extends 'techstore/storeadmin-page.html' %}
{% block content %}
<div class="container">
  <h3>Dashboard</h3>
  <ul class="nav nav-tabs">
    <li class="nav-item">
      <a class="nav-link active" data-bs-toggle="tab" href="#product_status">Products status</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#charts">Report</a>
    </li>
  </ul>
  <div class="tab-content mt-3">
    <div class="tab-pane fade show active" id="product_status" role="tabpanel">
      <h4 class="mt-4">Product Details</h4>
      <!-- Filters -->
      <div class="row mt-3 mb-2">
        <div class="col-md-3">
          <input type="text" id="productSearch" class="form-control" placeholder="Search category or model">
        </div>
        <div class="col-md-2">
          <input type="date" id="startDate" class="form-control">
        </div>
        <div class="col-md-2">
          <input type="date" id="endDate" class="form-control">
        </div>
        <div class="col-md-2">
          <button class="btn btn-success w-100" id="exportCSV">Export CSV</button>
        </div>
        <div class="col-md-2">
          <button class="btn btn-secondary w-100" id="clearFilters">Clear</button>
        </div>
      </div>
      <!-- Table -->
      <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
        <table class="table table-bordered">
          <thead class="table-info">
            <tr>
              <th>ID</th>
              <th>Category</th>
              <th>Model</th>
              <th>Purchased Date</th>
              <th>Quantity Received</th>
              <th>Quantity Supplied</th>
              <th>Quantity in Stock</th>
            </tr>
          </thead>
          <tbody id="productStatusTableBody">
            {% for item in product_status %}
            <tr>
              <td>{{ item.id }}</td>
              <td>{{ item.category }}</td>
              <td>{{ item.model }}</td>
              <td>{{ item.purchased_date }}</td>
              <td>{{ item.quantity_received }}</td>
              <td>{{ item.quantity_supplied }}</td>
              <td>{{ item.quantity_in_stock }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    
    
    <div class="tab-pane fade" id="charts" role="tabpanel">
      {% comment %}       
      <h5 class="mt-4">Total Products Received vs. Supplied</h5>
      <canvas id="receivedVsSuppliedChart" height="100"></canvas>

      
      <div class="mt-4"
        <h5>Supply vs Stock (Per Category)</h5>
        <div id="categoryPieCharts" class="row"></div>
      </div>
        

      <div id="userwiseSupplyCharts" class="row"></div>
      
      <div class="row" id="userwiseSupplyBarCharts"></div>

      
      <div class="mt-4">
        <h5>Model-wise Products: Received vs. Supplied</h5>
        <canvas id="modelBarChart" height="100"></canvas>
      </div> {% endcomment %}

      {% comment %} First chart - stacked bar chart for received vs supplied  {% endcomment %}
      <div class="mt-4">
        <h4>Product Quantities by Category</h4>
        <canvas id="categoryChart" height="100"></canvas>
      </div>

      <div class="card mt-4">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">Received vs Supplied – Model-wise</h5>
        </div>
        <div class="card-body">
          <canvas id="modelChart" height="100"></canvas>
        </div>
      </div>

    </div>
  </div>

  {% comment %} filter for first table  {% endcomment %}
  <script>
    function fetchProductStatus() {
      const search = document.getElementById("productSearch").value;
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
  
      fetch(`/dashboard/product-status/filter/?search=${search}&start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
          const tbody = document.getElementById("productStatusTableBody");
          tbody.innerHTML = "";
  
          if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">No records found</td></tr>';
          } else {
            data.forEach((item) => {
              tbody.innerHTML += `
                <tr>
                  <td>${item.id}</td>
                  <td>${item.category}</td>
                  <td>${item.model}</td>
                  <td>${item.purchased_date}</td>
                  <td>${item.quantity_received}</td>
                  <td>${item.quantity_supplied}</td>
                  <td>${item.quantity_in_stock}</td>
                </tr>`;
            });
          }
        });
    }
  
    document.getElementById("productSearch").addEventListener("input", fetchProductStatus);
    document.getElementById("startDate").addEventListener("change", fetchProductStatus);
    document.getElementById("endDate").addEventListener("change", fetchProductStatus);
  
    document.getElementById("exportCSV").addEventListener("click", function () {
      const search = document.getElementById("productSearch").value;
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
  
      const url = `/dashboard/product-status/export/?search=${search}&start_date=${startDate}&end_date=${endDate}`;
      window.location.href = url;
    });
    // ✅ Clear Button Function
    document.getElementById("clearFilters").addEventListener("click", function () {
      document.getElementById("productSearch").value = "";
      document.getElementById("startDate").value = "";
      document.getElementById("endDate").value = "";
      fetchProductStatus();  // Reload full table
    });

    // Initial load
    fetchProductStatus();
  </script>

{% comment %} First chart - stacked bar chart for received vs supplied  {% endcomment %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const ctx = document.getElementById('categoryChart').getContext('2d');
    let categoryChart;

    function fetchChartData() {
      fetch("{% url 'category_chart_data' %}")
        .then(response => response.json())
        .then(data => {
          const labels = data.categories;
          const receivedData = data.received;
          const suppliedData = data.supplied;

          const chartData = {
            labels: labels,
            datasets: [
              {
                label: 'Received',
                data: receivedData,
                backgroundColor: 'rgba(76, 175, 80, 0.3)',  // light green
                borderColor: 'rgba(76, 175, 80, 0.5)',
                borderWidth: 1,
                barThickness: 40,
                grouped: false,
                order: 1,
              },
              {
                label: 'Supplied',
                data: suppliedData,
                backgroundColor: 'rgba(33, 150, 243, 0.9)',  // strong blue
                borderColor: 'rgba(33, 150, 243, 1)',
                borderWidth: 1,
                barThickness: 20,
                grouped: false,
                order: 2,
              }
            ]
          };

          const config = {
            type: 'bar',
            data: chartData,
            options: {
              responsive: true,
              plugins: {
                legend: { position: 'top' },
                tooltip: {
                  mode: 'index',
                  intersect: false,
                  callbacks: {
                    afterBody: function (tooltipItems) {
                      // Find received and supplied from tooltipItems
                      let received = 0;
                      let supplied = 0;
                      tooltipItems.forEach(item => {
                        if (item.dataset.label === 'Received') {
                          received = item.raw;
                        }
                        if (item.dataset.label === 'Supplied') {
                          supplied = item.raw;
                        }
                      });
            
                      const inStock = received - supplied;
                      return 'In Stock: ' + inStock;
                    }
                  }
                }
              },
              scales: {
                x: { stacked: false },
                y: {
                  stacked: false,
                  beginAtZero: true
                }
              }
            }
            
          };

          if (categoryChart) {
            categoryChart.destroy();
          }

          categoryChart = new Chart(ctx, config);
        });
      }

    fetchChartData();
  });
</script>



</div>
{% endblock %}
